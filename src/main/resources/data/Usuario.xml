<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//PT-BR"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="br.com.usjt.web.service.UsuarioMapper">
	<resultMap id="usuario" autoMapping="false" type="br.com.usjt.web.model.Usuario">
		<id property="cpf" column="cpf" />
		<result property="tipo" column="tipo" />
		<result property="cpf" column="cpf" />
		<result property="nome" column="nome" />
		<result property="dta_nascimento" column="dta_nascimento" />
		<result property="email" column="email" />
		<result property="ddd" column="ddd" />
		<result property="telefone" column="telefone" />
		<result property="genero" column="genero" />
		<result property="senha" column="senha" />
		<association property="endereco" javaType="br.com.usjt.web.model.Endereco">
			<id property="id" column="id" />
			<result property="logradouro" column="logradouro" />
			<result property="numero" column="numero" />
			<result property="complemento" column="complemento" />
			<result property="bairro" column="bairro" />
			<result property="cidade" column="cidade" />
			<result property="cep" column="cep" />
		</association>
	</resultMap>
	
	<select id="getUsuarioByParameter" resultMap="usuario">
		select 
			usu.tipo, 
			usu.cpf, 
			usu.nome, 
			date_format(usu.dta_nascimento, '%d/%m/%Y') as dta_nascimento, 
			usu.email, 
			usu.ddd, 
			usu.telefone, 
			usu.genero, 
			usu.senha,
			usu.endereco,
	        end.id,
	        end.logradouro,
	        end.numero,
	        end.complemento,
	        end.bairro,
	        end.cidade,
	       	end.uf,
	       	end.cep
		  from usuario usu
		  	left join endereco end
		      on usu.endereco = end.id 
		  <if test="tipo != null">
		  	where 
		    	<choose>
			  <when test="tipo == 'id'">
			    usu.id = #{parametro}
			  </when>
			  <when test="tipo == 'email'">
			    usu.email = #{parametro}
			  </when>
			</choose>
		  </if>
	</select>
	
	<select id="getUsuarioOnLogin" resultType="br.com.usjt.web.model.Usuario">
		select 
			id,
			tipo, 
			cpf, 
			nome, 
			date_format(dta_nascimento, '%d/%m/%Y') as dta_nascimento, 
			email, 
			ddd, 
			telefone, 
			genero, 
			senha,
			endereco 
		  from usuario
		  where 
		  	email = #{email}
		  AND
		  	senha = #{senha}
	</select>
	
	<!-- createUsuario() referente ao segundo semestre -->
	<insert id="createUsuario">
		INSERT
			INTO usuario
			  (
			  	tipo,
			    cpf,
			    nome,
			    dta_nascimento,
			    email,
			    ddd,
			    telefone,
			    genero,
			    senha,
			    endereco
			  ) VALUES(
			  	#{usuario.tipo}
			    #{usuario.cpf},
			    upper(#{usuario.nome}),
			    str_to_date(#{usuario.dta_nascimento}, '%d/%m/%Y'),
			    lower(#{usuario.email}),
			    #{usuario.ddd},
			    #{usuario.telefone},
			    #{usuario.genero},
			    #{usuario.senha}
				#{usuario.endereco.id}
			  )
				
	</insert>
	
	<insert id="updateCliente">
		UPDATE usuario set 
				tipo=#{usuario.tipo},
			    cpf=#{usuario.tipo},
			    nome=upper(#{usuario.nome}),
			    dta_nascimento=str_to_date(#{usuario.dta_nascimento}, '%d/%m/%Y'),
			    email=lower(#{usuario.email}),
			    ddd=#{usuario.ddd},
			    telefone=#{usuario.telefone},
			    genero=#{usuario.genero},
			    senha=#{usuario.senha},
			    endereco=#{usuario.endereco.id}
			    where id = #{usuario.id}
	</insert>
</mapper>