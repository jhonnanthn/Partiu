<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//PT-BR"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="br.com.usjt.web.service.RecomendacaoMapper">
	<resultMap id="restaurante" type="br.com.usjt.web.model.Restaurante">
		<id property="cnpj" column="cnpj" />
		<result property="qtdMesas" column="qtd_mesas" />
		<result property="codigoComanda" column="codigo_cardapio" />
		<result property="nomeFantasia" column="nom_fantasia" />
		<result property="razaoSocial" column="razao_social" />
		<result property="status" column="status" />
		<result property="descricao" column="descricao" />
		<result property="logo" column="logotipo" />
		<association property="endereco" javaType="br.com.usjt.web.model.Endereco">
			<id property="id" column="id" />
			<result property="logradouro" column="logradouro" />
			<result property="numero" column="numero" />
			<result property="complemento" column="complemento" />
			<result property="bairro" column="bairro" />
			<result property="cidade" column="cidade" />
			<result property="uf" column="uf" />
			<result property="cep" column="cep" />
		</association>
	</resultMap>

	<select id="getRecomendacaoDiaSemana" resultMap="restaurante">
SELECT r.cnpj,	r.qtd_mesas, r.codigo_cardapio, r.razao_social, r.logotipo, r.nom_fantasia, r.status,r.descricao, r.id_endereco,
	   		   e.id, e.logradouro, e.numero, e.complemento, e.bairro, e.cidade, e.uf, e.cep
		FROM restaurante r
			INNER JOIN endereco e ON r.id_endereco = e.id
			LEFT JOIN funcionario_restaurante fr ON r.cnpj = fr.cnpj_restaurante
			LEFT JOIN usuario u ON u.id = fr.id_funcionario
			LEFT JOIN comanda c ON c.id_garcom = u.id
			LEFT JOIN avaliacao a ON a.id_comanda = c.id
			WHERE  DAYOFWEEK(sysdate()) = DAYOFWEEK(c.dta_entrada)
				AND c.dta_entrada >= last_day(now()) + interval 1 day - interval 2 month
				ORDER BY a.av_estabelecimento DESC
                LIMIT 10
	</select>
	
	<select id="getRecomendacaoMaisVisitados" resultMap="restaurante">
		select x.* from (
			SELECT 
				r.cnpj,	r.qtd_mesas, r.codigo_cardapio, r.razao_social, r.logotipo, r.nom_fantasia, r.status,r.descricao, r.id_endereco,
				e.id, e.logradouro, e.numero, e.complemento, e.bairro, e.cidade, e.uf, e.cep, count(1)
			FROM restaurante r
			INNER JOIN endereco e ON r.id_endereco = e.id
			LEFT JOIN funcionario_restaurante fr ON r.cnpj = fr.cnpj_restaurante
			LEFT JOIN usuario u ON u.id = fr.id_funcionario
			INNER JOIN comanda c ON c.id_garcom = u.id
			LEFT JOIN avaliacao a ON a.id_comanda = c.id
			group by
				r.cnpj,	r.qtd_mesas, r.codigo_cardapio, r.razao_social, r.logotipo, r.nom_fantasia, r.status,r.descricao, r.id_endereco,
				e.id, e.logradouro, e.numero, e.complemento, e.bairro, e.cidade, e.uf, e.cep) x
            limit 0,8
	</select>
	
	<select id="getRecomendacaoVisitadoRecentente" resultMap="restaurante">
		SELECT 
			r.cnpj,	r.qtd_mesas, r.codigo_cardapio, r.razao_social, r.logotipo, r.nom_fantasia, r.status,r.descricao, r.id_endereco,
			e.id, e.logradouro, e.numero, e.complemento, e.bairro, e.cidade, e.uf, e.cep
		FROM usuario u
		INNER JOIN usuario_comanda com_user ON com_user.cod_usuario = u.id
		INNER JOIN comanda c on c.id = com_user.cod_comanda
           
        INNER JOIN funcionario_restaurante fr ON fr.id_funcionario = c.id_garcom
        INNER JOIN restaurante r on r.cnpj = fr. cnpj_restaurante
		INNER JOIN endereco e ON r.id_endereco = e.id
           where
			u.id = #{idUsuario}
		order by c.dta_entrada desc
        limit 0,8
	</select>
</mapper>